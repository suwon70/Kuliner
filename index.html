<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Katalog Kuliner - Final</title>
<style>
  /* Mengatur ulang CSS dasar untuk semua elemen */
  *{box-sizing:border-box;margin:0;padding:0}
  /* Mendefinisikan variabel warna CSS untuk kemudahan penggunaan */
  :root{ --accent:#ff5722; --accent-dark:#e64a19; --ok:#4caf50; --danger:#d32f2f; }

  /* Gaya dasar untuk body */
  body{font-family:system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;background:#f5f5f5;color:#222;line-height:1.4;}
  
  /* Gaya untuk Header */
  header{
    position:sticky;top:0;z-index:1000;
    background:var(--accent);color:#fff;padding:12px 10px;
    display:flex;align-items:center;justify-content:center; /* Mengatur konten utama di tengah */
  }
  #headerLeft{
    display:flex;
    flex-direction:column;
    text-align:center; /* Memusatkan teks di dalam kontainer */
  }
  #storeTitle{font-size:18px;font-weight:700}
  #storeContact{font-size:12px;color:#4caf50;font-weight:600;}

  /* Gaya untuk keranjang cepat */
  #cartContainer{
    position:absolute; /* Memposisikan secara absolut */
    right:10px;
    top:50%;
    transform:translateY(-50%); /* Menengahkan vertikal */
    display:flex;flex-direction:column;align-items:center;gap:6px;
  }
  #cartBtn{background:#2e7d32;color:#fff;border:none;border-radius:50%;width:44px;height:44px;font-size:18px;cursor:pointer;position:relative}
  #cartCount{
    position:absolute;top:-6px;right:-6px;
    background:#ff0000;
    color:#fff;
    border-radius:50%;
    padding:2px 6px;
    font-size:14px;
    font-weight:700;
  }

  /* Kategori yang menempel (sticky) */
  #categoryFilter{
    display:flex;gap:8px;padding:8px;background:#fff;position:sticky;top:56px;z-index:999;overflow-x:auto;
    box-shadow:0 1px 3px rgba(0,0,0,.06);
  }
  .cat-btn{flex:0 0 auto;padding:6px 12px;border-radius:18px;border:none;background:#eee;cursor:pointer}
  .cat-btn.active{background:var(--accent);color:#fff}

  /* Daftar utama produk */
  .container{padding:12px;}
  .product{
    background:#fff;border-radius:10px;padding:10px;margin-bottom:12px;box-shadow:0 2px 6px rgba(0,0,0,.06);
  }
  .product img{width:100%;height:auto;object-fit:contain;border-radius:8px;margin-bottom:8px}
  .product h3{color:var(--accent);font-size:16px;margin-bottom:4px}
  .product .meta{font-size:13px;color:#444;margin-bottom:6px}
  .qty-controls{display:flex;align-items:center;gap:8px}
  .qty-btn{border:none;padding:6px 10px;border-radius:6px;background:var(--accent);color:#fff;cursor:pointer}
  .subtotal{font-weight:700;color:#2e7d32;margin-top:6px}

  /* panel keranjang (geser dari bawah) */
  #cartPanel{
    position:fixed;left:0;right:0;bottom:0;transform:translateY(110%);transition:.28s;z-index:1100;
    max-height:84vh;background:#fff;border-top-left-radius:12px;border-top-right-radius:12px;box-shadow:0 -6px 18px rgba(0,0,0,.12);overflow:auto;
  }
  #cartPanel.show{transform:translateY(0)}
  .panel-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #eee;position:sticky;top:0;background:#fff;z-index:1110}
  .panel-head h3{margin:0;text-align:center;flex:1;font-size:16px}
  .cart-items{padding:12px}
  .cart-item{display:flex;gap:8px;align-items:center;padding:8px 0;border-bottom:1px dashed #eee}
  .cart-item img{width:48px;height:48px;object-fit:cover;border-radius:6px}
  .cart-item .info{flex:1}
  .cart-footer{padding:12px;border-top:1px solid #eee}
  .btn-primary{background:var(--accent);color:#fff;padding:10px;border:none;border-radius:8px;width:100%;cursor:pointer}
  .btn-danger{background:var(--danger);color:#fff;padding:8px;border:none;border-radius:8px;cursor:pointer}

  /* tombol mengambang admin + modal */
  #adminBtn{position:fixed;left:14px;bottom:18px;background:#455a64;color:#fff;border:none;padding:12px;border-radius:50%;z-index:1200;cursor:pointer}
  #adminMode{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:2000;align-items:flex-end;justify-content:center}
  .admin-sheet{background:#fff;width:720px;max-width:98%;max-height:92vh;overflow:auto;border-top-left-radius:12px;border-top-right-radius:12px;padding:14px}
  .admin-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .admin-row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px}
  .admin-row label{flex:1 1 200px;font-size:13px}
  .field{width:100%;padding:8px;border-radius:6px;border:1px solid #ddd}

  .admin-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .admin-product{border:1px solid #eee;padding:8px;border-radius:8px;margin-bottom:8px;display:flex;gap:8px;align-items:center}
  .admin-product img{width:54px;height:44px;object-fit:cover;border-radius:6px}
  .admin-product .meta{font-size:13px}

  /* Helpers kecil */
  .small{font-size:13px;color:#666}
  .flex-between{display:flex;justify-content:space-between;align-items:center}
  
  /* Modal Laporan Penjualan */
  #reportModal{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 9999;
      display: none;
      justify-content: center;
      align-items: center;
  }
  .report-box{
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      animation: fadeIn 0.3s ease-out;
  }
  @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
  }
  .report-box h4 { margin-top: 0; }
  .report-text {
      font-family: monospace;
      white-space: pre-wrap;
      background: #f8f8f8;
      padding: 10px;
      border-radius: 5px;
      border: 1px dashed #ccc;
      font-size: 14px;
      margin-bottom: 15px;
  }
  .report-actions {
      display: flex;
      gap: 10px;
  }

  /* Responsif */
  @media (max-width:520px){
    header{padding:10px}
    #categoryFilter{top:56px}
    .product img{height:auto}
    .admin-sheet{width:100%;height:94vh;border-radius:12px}
    .admin-row label{flex:1 1 100%}
    .panel-head h3{font-size:15px}
    #cartBtn{width:40px;height:40px}
  }

  /* Gaya baru untuk bagian gambar */
  #imageUploadContainer {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  /* Gaya untuk mencetak */
  #print-area {
      display: none; /* Sembunyikan secara default */
  }
  @media print {
      body * {
          visibility: hidden;
      }
      #print-area {
          visibility: visible;
          display: block !important; /* Pastikan terlihat saat mencetak */
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
          font-family: monospace;
          padding: 10px;
      }
      #print-area h2, #print-area h3 {
          text-align: center;
      }
      #print-area table {
          width: 100%;
          border-collapse: collapse;
      }
      #print-area th, #print-area td {
          border-bottom: 1px dashed #000;
          padding: 4px 0;
          text-align: left;
      }
      #print-area .text-right {
          text-align: right;
      }
      #print-area .total {
          font-weight: bold;
      }
  }
</style>
</head>
<body>

  <header>
    <div id="headerLeft">
      <div id="storeTitle">Warung Kita</div>
      <div id="storeContact">üìû 628123456789 | üìç Jl. Contoh No.1</div>
    </div>
    <div id="cartContainer" aria-hidden="false">
      <button id="cartBtn" aria-label="Buka keranjang">üõí<span id="cartCount">0</span></button>
    </div>
  </header>

  <div id="categoryFilter" aria-label="Filter Kategori"></div>

  <div class="container" id="buyerMode"></div>

  <div id="cartPanel" aria-hidden="true">
    <div class="panel-head">
      <button class="btn-back" onclick="closeCart()" style="background:#eee;border:none;padding:8px;border-radius:8px;cursor:pointer">‚¨Ö Kembali</button>
      <h3>üõí Keranjang</h3>
      <button class="btn-close" onclick="closeCart()" style="background:transparent;border:none;font-size:18px;cursor:pointer">‚úñ</button>
    </div>

    <div class="cart-items" id="cartItems"></div>

    <div class="cart-footer">
      <div class="flex-between"><div class="small">Total:</div><div id="cartTotal" style="font-weight:700">Rp 0</div></div>
      <div style="margin-top:10px; display:flex; gap: 8px;">
        <button class="btn-primary" onclick="checkoutWA()" style="flex:1;">Checkout via WhatsApp</button>
        <button class="btn-primary" onclick="printReceipt()" style="flex:1; background:#455a64;">Cetak Nota</button>
      </div>
      <div style="margin-top:8px"><button class="btn-danger" onclick="clearCart()">Kosongkan Keranjang</button></div>
    </div>
  </div>

  <button id="adminBtn" title="Admin" onclick="openAdmin()" style="display: none;">‚öô</button>

  <div id="adminMode" onclick="closeAdminBackdrop(event)">
    <div class="admin-sheet" role="dialog" aria-modal="true">
      <div class="admin-head">
        <button class="btn-back" onclick="closeAdmin()" style="padding:8px;border-radius:8px;border:none;background:#eee;cursor:pointer">‚¨Ö Kembali</button>
        <h3 style="margin:0">‚öô Admin Panel</h3>
        <button onclick="closeAdmin()" style="background:transparent;border:none;cursor:pointer;font-size:18px">‚úñ</button>
      </div>

      <h4>Pengaturan Toko</h4>
      <div class="admin-row">
        <label>Nama Toko<br><input id="storeName" class="field" placeholder="Nama Toko"></label>
        <label>No. WhatsApp<br><input id="storeWAInput" class="field" placeholder="62xxxxxxxxxx"></label>
        <label>Alamat<br><input id="storeAddressInput" class="field" placeholder="Alamat"></label>
      </div>
      <div class="admin-row">
        <label>Background Body<br><input type="file" id="bgInput" accept="image/*" class="field"></label>
        <label>Background Header<br><input type="file" id="bgHeaderInput" accept="image/*" class="field"></label>
      </div>
      <div class="admin-actions">
        <button class="btn" onclick="saveSettings()" style="background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px">Simpan Pengaturan</button>
        <button class="btn" onclick="resetData()" style="background:var(--danger);color:#fff;padding:8px 12px;border-radius:8px">Reset Data</button>
      </div>

      <hr style="margin:12px 0">

      <h4 id="formTitle">Tambah Produk</h4>
      <div class="admin-row">
        <label>Nama Produk<br><input id="prodName" class="field" placeholder="Nama produk"></label>
        <label>Harga (angka)<br><input id="prodPrice" type="number" class="field" placeholder="10000"></label>
      </div>
      <div class="admin-row">
        <label>Minimal Beli<br><input id="prodMinBuy" type="number" class="field" value="1" min="1"></label>
        <label>Status<br>
          <select id="prodStatus" class="field">
            <option value="Ready">Ready</option>
            <option value="Habis">Habis</option>
          </select>
        </label>
        <label>Kategori<br><input id="prodCategory" class="field" placeholder="misal: Nasi / Minuman"></label>
      </div>
      <div class="admin-row">
        <label style="flex:1 1 100%">Deskripsi<br><textarea id="prodDesc" class="field" rows="3" placeholder="Deskripsi singkat"></textarea></label>
      </div>
      <div class="admin-row">
        <div style="flex:1 1 200px" id="imageUploadContainer">
          <label>Gambar Produk</label>
          <div style="display: flex; gap: 8px;">
            <button id="modeBtnFile" onclick="switchImageMode('file')" style="flex: 1; padding: 8px; border-radius: 6px; border: 1px solid #ccc; background: #eee; cursor: pointer;">Unggah File</button>
            <button id="modeBtnUrl" onclick="switchImageMode('url')" style="flex: 1; padding: 8px; border-radius: 6px; border: 1px solid #ccc; background: transparent; cursor: pointer;">Dari URL</button>
          </div>
          <input id="prodImgFile" type="file" accept="image/*" class="field" style="display: block;">
          <input id="prodImgUrl" type="url" class="field" placeholder="https://contoh.com/gambar.jpg" style="display: none;">
        </div>
        <div style="min-width:120px;">
          <div class="small" style="margin-bottom:6px">Preview</div>
          <img id="prodPreview" src="" alt="" style="width:120px;height:80px;object-fit:cover;border-radius:6px;border:1px solid #eee;display:none">
        </div>
      </div>

      <div class="admin-actions">
        <button id="prodBtn" class="btn" onclick="addOrUpdateProduct()" style="background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px">Tambah</button>
        <button class="btn" onclick="clearProductForm()" style="background:#ddd;padding:8px 12px;border-radius:8px">Bersihkan Form</button>
      </div>

      <hr style="margin:12px 0">
      <div class="flex-between">
        <h4>Daftar Produk</h4>
        <button class="btn" onclick="openReportModal()" style="background:#2e7d32;color:#fff;padding:6px 12px;border-radius:8px">Cetak/Kirim Laporan</button>
      </div>
      <div id="adminProducts"></div>
    </div>
  </div>

  <div id="reportModal" onclick="if(event.target.id === 'reportModal') closeReportModal();">
      <div class="report-box">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <h4>Laporan Penjualan</h4>
              <button onclick="closeReportModal()" style="background: transparent; border: none; font-size: 18px; cursor: pointer;">‚úñ</button>
          </div>
          <pre id="reportText" class="report-text"></pre>
          <div class="report-actions">
              <button onclick="copyReportText()" style="flex: 1; padding: 8px; border: none; border-radius: 6px; background: #ddd; cursor: pointer;">Salin Teks</button>
              <button onclick="sendReportToWhatsApp()" style="flex: 1; padding: 8px; border: none; border-radius: 6px; background: #25D366; color: white; cursor: pointer;">Kirim ke WhatsApp</button>
          </div>
      </div>
  </div>
  
  <div id="print-area"></div>

<script>
/* ======================== */
/* DATA APLIKASI           */
/* ======================== */
let settings = { toko:"Warung Kita", wa:"628123456789", alamat:"Jl. Contoh No.1", pass:"1234", bg:"", bgHeader:"" };
let products = [
  { name:"Nasi Goreng Biasa", price:10000, minBuy:1, status:"Ready", desc:"Nasi goreng sederhana dengan telur.", category:"Nasi", img:"" },
  { name:"Mie Goreng Jawa", price:16000, minBuy:1, status:"Ready", desc:"Mie goreng khas Jawa.", category:"Mie Goreng", img:"" },
  { name:"Es Teh Manis", price:4000, minBuy:1, status:"Ready", desc:"Es teh manis segar.", category:"Minuman", img:"" }
];
let cart = [];
let totalSales = 0;
let editIndex = -1;
let currentCategory = "Semua";

/* Mengembalikan data dari Local Storage saat aplikasi dimuat */
if(localStorage.getItem("settings")) settings = JSON.parse(localStorage.getItem("settings"));
if(localStorage.getItem("products")) products = JSON.parse(localStorage.getItem("products"));
if(localStorage.getItem("cart")) cart = JSON.parse(localStorage.getItem("cart"));
if(localStorage.getItem("totalSales")) totalSales = JSON.parse(localStorage.getItem("totalSales"));

/* ======================== */
/* FUNGSI PEMBANTU         */
/* ======================== */
// Menyimpan semua data ke Local Storage
function saveAll(){ 
  localStorage.setItem("settings", JSON.stringify(settings));
  localStorage.setItem("products", JSON.stringify(products)); 
  localStorage.setItem("cart", JSON.stringify(cart));
  localStorage.setItem("totalSales", JSON.stringify(totalSales));
}
// Memformat angka menjadi format Rupiah
function formatRupiah(num){ num = parseInt(num||0); return "Rp "+num.toString().replace(/\B(?=(\d{3})+(?!\d))/g,"."); }
// Mengaplikasikan gambar latar belakang
function applyBackgrounds(){
  if(settings.bg){ document.body.style.background = `url('${settings.bg}') no-repeat center center fixed`; document.body.style.backgroundSize = "cover"; }
  else document.body.style.background = "#f5f5f5";
  const hdr = document.querySelector("header");
  if(settings.bgHeader){ hdr.style.background = `url('${settings.bgHeader}') center/cover no-repeat`; hdr.style.color = "#fff"; hdr.style.backgroundSize = "cover"; } 
  else hdr.style.background = "var(--accent)";
}

/* ======================== */
/* RENDER UI               */
/* ======================== */
// Merender tombol kategori
function renderCategories(){
  const cats = [...new Set(products.map(p => p.category || "Lainnya"))];
  const container = document.getElementById("categoryFilter");
  let html = `<button class="cat-btn ${currentCategory==='Semua'?'active':''}" onclick="setCategory('Semua')">Semua</button>`;
  cats.forEach(c => html += `<button class="cat-btn ${currentCategory===c?'active':''}" onclick="setCategory('${c}')">${c}</button>`);
  container.innerHTML = html;
}

// Merender daftar produk untuk pembeli
function renderProducts(){
  const buyer = document.getElementById("buyerMode");
  buyer.innerHTML = "";
  renderCategories();
  const show = (currentCategory==="Semua")? products : products.filter(p => p.category === currentCategory);
  if(show.length === 0){ buyer.innerHTML = `<p style="text-align:center;color:#777;margin-top:18px">Tidak ada produk.</p>`; return; }
  show.forEach(p => {
    const itemInCart = cart.find(c => c.name === p.name);
    const qty = itemInCart ? itemInCart.qty : 0;
    const imgHTML = p.img ? `<img src="${p.img}" alt="${p.name}">` : '';
    buyer.innerHTML += `
      <div class="product">
        ${imgHTML}
        <h3>${p.name}</h3>
        <div class="meta"><span>${p.category || ''}</span> ¬∑ <span>${p.status}</span></div>
        <div class="meta"><b>Harga:</b> ${formatRupiah(p.price)}</div>
        ${p.minBuy && p.minBuy > 1 ? `<div class="meta" style="font-weight:700;color:var(--danger)">Minimal: ${p.minBuy}</div>` : ''}
        <p class="small">${p.desc||''}</p>
        <div class="qty-controls">
          <button class="qty-btn" onclick="decreaseProductByName('${encodeURIComponent(p.name)}')">‚àí</button>
          <div style="min-width:26px;text-align:center">${qty}</div>
          <button class="qty-btn" onclick="increaseProductByName('${encodeURIComponent(p.name)}')">+</button>
        </div>
        <div class="subtotal">Subtotal: ${formatRupiah(qty * p.price)}</div>
      </div>`;
  });
  document.getElementById("storeTitle").textContent = settings.toko;
  document.getElementById("storeContact").textContent = `üìû ${settings.wa} | üìç ${settings.alamat}`;
  applyBackgrounds();
  renderCart();
}

/* ======================== */
/* FILTER KATEGORI         */
/* ======================== */
function setCategory(cat){ currentCategory = cat; renderProducts(); }

/* ======================== */
/* FUNGSI KERANJANG        */
/* ======================== */
function increaseProductByName(encodedName){
  const name = decodeURIComponent(encodedName);
  const p = products.find(x=>x.name === name);
  if(!p || p.status === 'Habis'){ alert("Produk tidak tersedia"); return; }
  const idx = cart.findIndex(c => c.name === p.name);
  if(idx > -1) cart[idx].qty++;
  else cart.push({ name: p.name, price: p.price, qty: p.minBuy || 1, img: p.img || '' });
  saveCartToLocal();
  renderProducts();
}
function decreaseProductByName(encodedName){
  const name = decodeURIComponent(encodedName);
  const idx = cart.findIndex(c => c.name === name);
  if(idx > -1){
    if(cart[idx].qty > 1) cart[idx].qty--;
    else cart.splice(idx,1);
    saveCartToLocal();
    renderProducts();
  }
}
function saveCartToLocal(){ localStorage.setItem("cart", JSON.stringify(cart)); renderCart(); }

/* ======================== */
/* PANEL KERANJANG         */
/* ======================== */
document.getElementById("cartBtn").addEventListener("click", ()=> toggleCart());
function toggleCart(){ document.getElementById("cartPanel").classList.toggle("show"); }

// Perbaikan: tambahkan renderProducts() saat keranjang ditutup
function closeCart(){ 
  document.getElementById("cartPanel").classList.remove("show"); 
  renderProducts();
}

function renderCart(){
  const wrap = document.getElementById("cartItems");
  wrap.innerHTML = "";
  let total = 0, totalQty = 0;
  cart.forEach((c,i) => {
    const sub = c.price * c.qty; total += sub; totalQty += c.qty;
    wrap.innerHTML += `
      <div class="cart-item">
        ${c.img?`<img src="${c.img}" alt="${c.name}">`:''}
        <div class="info">
          <div style="font-weight:700">${c.name}</div>
          <div class="small">${formatRupiah(c.price)} x ${c.qty} = ${formatRupiah(sub)}</div>
          <div style="margin-top:6px">
            <button class="qty-btn" onclick="decreaseCart(${i})">‚àí</button>
            <button class="qty-btn" onclick="increaseCart(${i})">+</button>
            <button style="background:#eee;border:none;padding:6px;border-radius:6px;margin-left:6px;cursor:pointer" onclick="removeCart(${i})">Hapus</button>
          </div>
        </div>
      </div>`;
  });
  document.getElementById("cartTotal").textContent = formatRupiah(total);
  document.getElementById("cartCount").textContent = totalQty;
}

function increaseCart(i){ cart[i].qty++; saveCartToLocal(); renderProducts(); }
function decreaseCart(i){ if(cart[i].qty>1) cart[i].qty--; else cart.splice(i,1); saveCartToLocal(); renderProducts(); }
function removeCart(i){ cart.splice(i,1); saveCartToLocal(); renderProducts(); }
function clearCart(){ if(confirm("Kosongkan keranjang?")){ cart=[]; saveCartToLocal(); renderProducts(); } }

/* ======================== */
/* CHECKOUT VIA WHATSAPP   */
/* ======================== */
function checkoutWA(){
  if(cart.length === 0){ alert("Keranjang kosong!"); return; }
  let msg = "Halo, saya ingin pesan:\n";
  let total = 0;
  cart.forEach(c => { msg += `- ${c.name} x${c.qty} = ${formatRupiah(c.price*c.qty)}\n`; total += c.price*c.qty; });
  msg += `\n*Total: ${formatRupiah(total)}*`;
  
  const wa = settings.wa || '';
  if(!wa){ alert("Nomor WhatsApp toko belum diisi (Admin)."); return; }
  
  // Tambahkan total keranjang ke totalSales sebelum mengosongkan keranjang
  totalSales += total;
  saveAll();

  window.open(`https://wa.me/${wa}?text=${encodeURIComponent(msg)}`, "_blank");
  
  // TIDAK MENGOSONGKAN keranjang secara otomatis lagi
  // Pembeli harus mengklik "Kosongkan Keranjang" secara manual.
}

/* ======================== */
/* FUNGSI CETAK NOTA        */
/* ======================== */
function printReceipt(){
  if(cart.length === 0){
    alert("Keranjang kosong, tidak ada yang bisa dicetak.");
    return;
  }
  
  const printArea = document.getElementById('print-area');
  
  let total = 0;
  let itemsHtml = '';
  cart.forEach(item => {
    const subtotal = item.price * item.qty;
    total += subtotal;
    itemsHtml += `
      <tr>
        <td>${item.name}</td>
        <td class="text-right">${item.qty}</td>
        <td class="text-right">${formatRupiah(item.price)}</td>
        <td class="text-right">${formatRupiah(subtotal)}</td>
      </tr>
    `;
  });
  
  const receiptHtml = `
    <h2>${settings.toko}</h2>
    <p style="text-align:center;">${settings.alamat}</p>
    <p style="text-align:center; margin-bottom: 20px;">Nota Pembelian</p>
    <table>
      <thead>
        <tr>
          <th>Item</th>
          <th class="text-right">Qty</th>
          <th class="text-right">Harga</th>
          <th class="text-right">Subtotal</th>
        </tr>
      </thead>
      <tbody>
        ${itemsHtml}
      </tbody>
    </table>
    <div style="text-align: right; margin-top: 10px; padding-top: 5px; border-top: 1px dashed #000;">
      <span class="total">Total: ${formatRupiah(total)}</span>
    </div>
    <p style="text-align:center; margin-top: 20px;">Terima kasih atas kunjungan Anda!</p>
  `;
  
  printArea.innerHTML = receiptHtml;
  window.print();
  
  // TIDAK MENGOSONGKAN keranjang secara otomatis lagi
  // Pembeli harus mengklik "Kosongkan Keranjang" secara manual.
}


/* ======================== */
/* LOGIKA ADMIN            */
/* ======================== */
// Fungsi untuk membuka panel admin, dipicu oleh tombol admin
function openAdmin(){
  // Masukkan password admin (default 1234)
  const pass = prompt("Masukkan password admin (default 1234):");
  if(pass !== (settings.pass || "1234")){ alert("Password salah!"); return; }
  
  // Sembunyikan tombol admin setelah panel berhasil dibuka
  document.getElementById('adminBtn').style.display = 'none';

  document.getElementById("adminMode").style.display = "flex";
  populateSettingsToForm();
  renderAdminProducts();
  scrollToTopAdmin();
}

// Fungsi untuk menutup panel admin.
function closeAdmin(){
  document.getElementById("adminMode").style.display = "none";
  editIndex = -1;
  clearProductForm();
}

// Fungsi untuk menutup panel admin saat mengklik latar belakang
function closeAdminBackdrop(e){
  if(e.target.id === "adminMode") closeAdmin();
}
function scrollToTopAdmin(){
  document.querySelector(".admin-sheet").scrollTop = 0;
}

function populateSettingsToForm(){
  document.getElementById("storeName").value = settings.toko || "";
  document.getElementById("storeWAInput").value = settings.wa || "";
  document.getElementById("storeAddressInput").value = settings.alamat || "";
}

/* Menyimpan pengaturan toko (dengan gambar opsional) */
function saveSettings(){
  settings.toko = document.getElementById("storeName").value || settings.toko;
  settings.wa = document.getElementById("storeWAInput").value || settings.wa;
  settings.alamat = document.getElementById("storeAddressInput").value || settings.alamat;
  const bgFile = document.getElementById("bgInput").files[0];
  const bgHdrFile = document.getElementById("bgHeaderInput").files[0];

  const afterSave = () => { saveAll(); renderProducts(); alert("Pengaturan tersimpan."); };

  if(bgFile){
    const r = new FileReader();
    r.onload = e => { settings.bg = e.target.result; if(bgHdrFile){ const r2 = new FileReader(); r2.onload = e2 => { settings.bgHeader = e2.target.result; afterSave(); }; r2.readAsDataURL(bgHdrFile);} else afterSave(); };
    r.readAsDataURL(bgFile);
  } else if(bgHdrFile){
    const r2 = new FileReader();
    r2.onload = e2 => { settings.bgHeader = e2.target.result; afterSave(); };
    r2.readAsDataURL(bgHdrFile);
  } else {
    afterSave();
  }
}

/* ======================== */
/* CRUD Produk Admin       */
/* ======================== */
const prodImgFile = document.getElementById("prodImgFile");
const prodImgUrl = document.getElementById("prodImgUrl");
const prodPreview = document.getElementById("prodPreview");
const modeBtnFile = document.getElementById("modeBtnFile");
const modeBtnUrl = document.getElementById("modeBtnUrl");

// Fungsi untuk beralih mode input gambar
function switchImageMode(mode) {
    if (mode === 'file') {
        prodImgFile.style.display = 'block';
        prodImgUrl.style.display = 'none';
        modeBtnFile.style.background = '#eee';
        modeBtnUrl.style.background = 'transparent';
    } else {
        prodImgFile.style.display = 'none';
        prodImgUrl.style.display = 'block';
        modeBtnFile.style.background = 'transparent';
        modeBtnUrl.style.background = '#eee';
    }
}

// Tambahkan event listener untuk preview gambar dari file
prodImgFile.addEventListener("change", function(){
  const f = this.files[0];
  if(!f){ prodPreview.style.display='none'; prodPreview.src=''; return; }
  const r = new FileReader();
  r.onload = e => { prodPreview.src = e.target.result; prodPreview.style.display = 'block'; };
  r.readAsDataURL(f);
});

// Tambahkan event listener untuk preview gambar dari URL
prodImgUrl.addEventListener("input", function(){
  const url = this.value;
  if(url) {
    prodPreview.src = url;
    prodPreview.style.display = 'block';
  } else {
    prodPreview.src = '';
    prodPreview.style.display = 'none';
  }
});

function addOrUpdateProduct(){
  const name = document.getElementById("prodName").value.trim();
  const price = parseInt(document.getElementById("prodPrice").value) || 0;
  const minBuy = parseInt(document.getElementById("prodMinBuy").value) || 1;
  const status = document.getElementById("prodStatus").value;
  const category = (document.getElementById("prodCategory").value || "Lainnya").trim();
  const desc = document.getElementById("prodDesc").value || "";

  if(!name || !price){ alert("Nama & harga wajib diisi."); return; }

  let imageSource = '';
  // Cek mode yang aktif berdasarkan display style
  if (prodImgFile.style.display !== 'none') {
    const file = prodImgFile.files[0];
    if (file) {
      const r = new FileReader();
      r.onload = e => {
        imageSource = e.target.result;
        commitProduct(imageSource);
      };
      r.readAsDataURL(file);
      return; // Keluar dari fungsi karena proses pembacaan file bersifat asinkron
    }
  } else {
    imageSource = prodImgUrl.value.trim();
  }

  // Jika tidak ada file yang dipilih atau mode URL aktif, langsung commit
  const existingImg = (editIndex > -1) ? (products[editIndex].img || "") : "";
  if (!imageSource && existingImg) {
    imageSource = existingImg;
  }
  
  commitProduct(imageSource);
}

function commitProduct(imgData) {
  const name = document.getElementById("prodName").value.trim();
  const price = parseInt(document.getElementById("prodPrice").value) || 0;
  const minBuy = parseInt(document.getElementById("prodMinBuy").value) || 1;
  const status = document.getElementById("prodStatus").value;
  const category = (document.getElementById("prodCategory").value || "Lainnya").trim();
  const desc = document.getElementById("prodDesc").value || "";
  
  const payload = { name, price, minBuy, status, desc, category, img: imgData || "" };
  if(editIndex === -1){
    products.push(payload);
    alert("Produk ditambahkan!");
  } else {
    products[editIndex] = payload;
    alert("Produk diupdate!");
  }
  saveAll(); renderAdminProducts(); renderProducts(); clearProductForm();
}


function renderAdminProducts(){
  const wrap = document.getElementById("adminProducts");
  wrap.innerHTML = "";
  products.forEach((p,i) => {
    wrap.innerHTML += `
      <div class="admin-product">
        ${p.img?`<img src="${p.img}" alt="${p.name}">`:''}
        <div style="flex:1">
          <div style="font-weight:700">${p.name}</div>
          <div class="small">${p.category} ¬∑ ${p.status} ¬∑ ${formatRupiah(p.price)}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px">
          <button style="background:var(--accent);color:#fff;border:none;padding:6px;border-radius:6px;cursor:pointer" onclick="editProduct(${i})">‚úè Edit</button>
          <button style="background:var(--danger);color:#fff;border:none;padding:6px;border-radius:6px;cursor:pointer" onclick="deleteProduct(${i})">üóë Hapus</button>
        </div>
      </div>`;
  });
}

function clearProductForm(){
  editIndex = -1;
  document.getElementById("formTitle").textContent = "Tambah Produk";
  document.getElementById("prodBtn").textContent = "Tambah";
  document.getElementById("prodName").value = "";
  document.getElementById("prodPrice").value = "";
  document.getElementById("prodMinBuy").value = "1";
  document.getElementById("prodStatus").value = "Ready";
  document.getElementById("prodCategory").value = "";
  document.getElementById("prodDesc").value = "";
  
  // Reset input gambar
  prodImgFile.value = "";
  prodImgUrl.value = "";
  prodPreview.style.display = 'none';
  prodPreview.src = '';
  switchImageMode('file');
}

function editProduct(i){
  const p = products[i];
  editIndex = i;
  document.getElementById("formTitle").textContent = "Edit Produk";
  document.getElementById("prodBtn").textContent = "Update";
  document.getElementById("prodName").value = p.name;
  document.getElementById("prodPrice").value = p.price;
  document.getElementById("prodMinBuy").value = p.minBuy;
  document.getElementById("prodStatus").value = p.status;
  document.getElementById("prodCategory").value = p.category;
  document.getElementById("prodDesc").value = p.desc;
  
  // Setel pratinjau gambar dan sesuaikan mode input
  if (p.img) {
      if (p.img.startsWith('data:')) {
          switchImageMode('file');
          // Tidak bisa mengatur nilai input file, hanya pratinjau
      } else {
          switchImageMode('url');
          prodImgUrl.value = p.img;
      }
      prodPreview.src = p.img;
      prodPreview.style.display = 'block';
  } else {
      clearProductForm();
  }
  document.querySelector(".admin-sheet").scrollTo({ top: 0, behavior: 'smooth' });
}

function deleteProduct(i){
  if(confirm("Hapus produk ini?")){
    products.splice(i,1);
    saveAll(); renderAdminProducts(); renderProducts();
  }
}

/* ======================== */
/* LAPORAN & RESET DATA    */
/* ======================== */
function openReportModal(){
    const date = new Date().toLocaleDateString('id-ID');
    const time = new Date().toLocaleTimeString('id-ID');
    const reportMessage = `Laporan Penjualan (Per ${date} Pukul ${time}):\n\nTotal Penjualan: ${formatRupiah(totalSales)}\n\n(Catatan: Laporan ini dihitung sejak terakhir kali data toko di-reset.)`;
    
    document.getElementById("reportText").textContent = reportMessage;
    document.getElementById("reportModal").style.display = "flex";
}

function closeReportModal(){
    document.getElementById("reportModal").style.display = "none";
}

function copyReportText(){
    const textToCopy = document.getElementById("reportText").textContent;
    navigator.clipboard.writeText(textToCopy)
        .then(() => {
            alert("Laporan berhasil disalin! Sekarang Anda bisa menempelkannya di WhatsApp.");
            closeReportModal();
        })
        .catch(err => {
            console.error('Gagal menyalin: ', err);
            alert("Gagal menyalin laporan. Silakan salin manual.");
        });
}

function sendReportToWhatsApp(){
    const textToEncode = document.getElementById("reportText").textContent;
    const wa = settings.wa || '';
    if(!wa){ alert("Nomor WhatsApp toko belum diisi (Admin)."); return; }
    window.open(`https://wa.me/${wa}?text=${encodeURIComponent(textToEncode)}`, "_blank");
    closeReportModal();
}

function resetData(){
  if(confirm("Yakin reset semua data? Ini akan menghapus settings, produk, dan keranjang.")){
    localStorage.removeItem("settings");
    localStorage.removeItem("products");
    localStorage.removeItem("cart");
    localStorage.removeItem("totalSales"); // Tambahkan ini
    location.reload();
  }
}

/* ======================== */
/* INISIATIF AWAL          */
/* ======================== */
function init(){
  document.getElementById("storeTitle").textContent = settings.toko;
  applyBackgrounds();
  renderAdminProducts();
  renderProducts();
  renderCart();
  // Menyesuaikan posisi top kategori saat memuat atau mengubah ukuran layar
  setTimeout(()=>{ const cat = document.getElementById("categoryFilter"); if(cat) cat.style.top = (document.querySelector('header').getBoundingClientRect().height + 2) + 'px'; }, 200);
  window.addEventListener("resize", ()=>{ const cat = document.getElementById("categoryFilter"); if(cat) cat.style.top = (document.querySelector('header').getBoundingClientRect().height + 2) + 'px'; });
}
init();

/* ==================================== */
/* Logika untuk menampilkan tombol admin */
/* ==================================== */

// Variabel untuk melacak jumlah ketukan di header
let headerClickCount = 0;

// Menambahkan event listener ke elemen header
document.querySelector('header').addEventListener('click', () => {
    // Setiap kali header diketuk, tambahkan 1 ke hitungan
    headerClickCount++;

    // Jika hitungan mencapai 3, tampilkan tombol admin
    if (headerClickCount >= 3) {
        document.getElementById('adminBtn').style.display = 'block';
        alert("Tombol admin muncul! (Admin button appeared!)");

        // Atur ulang hitungan setelah 1 detik untuk mencegah kemunculan yang tidak disengaja
        setTimeout(() => {
            headerClickCount = 0;
        }, 1000); // 1000 milidetik = 1 detik
    }
});

/* ======================== */
/* DEBUGGING & EXPOSE      */
/* ======================== */
window.saveAll = saveAll;
</script>
</body>
</html>
